<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de T√©moignages - √âcole des Gu√©risseuses</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #c77daa;
            --primary-dark: #b8659d;
            --secondary: #d89bb8;
            --success: #7fb69e;
            --warning: #f39c12;
            --danger: #e07a8a;
            --dark: #4a4a4a;
            --light: #ffeef5;
            --gray: #a8a8a8;
            --bg-pink: #ffd4e5;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #ffd4e5 0%, #ffebf0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(199, 125, 170, 0.2);
        }
        
        /* HEADER */
        .app-header {
            background: linear-gradient(135deg, #ffd4e5 0%, #ffb3d9 100%);
            color: var(--dark);
            padding: 30px 40px;
            position: relative;
            overflow: hidden;
        }
        
        .app-header::before {
            content: '‚ú®';
            position: absolute;
            right: 40px;
            top: 20px;
            font-size: 24px;
            opacity: 0.6;
        }
        
        .app-header h1 {
            font-size: 32px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .app-header p {
            opacity: 0.8;
            font-size: 16px;
        }
        
        /* CONFIG PANEL */
        .config-panel {
            background: #fff9fc;
            border: 2px solid var(--light);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 40px;
        }
        
        .config-panel.hidden {
            display: none;
        }
        
        .config-panel h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .config-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .config-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .config-input-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .config-input-group input {
            padding: 10px 15px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }
        
        .config-input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .config-buttons {
            display: flex;
            gap: 10px;
        }
        
        .config-status {
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
        }
        
        .config-status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .config-status.error {
            background: #ffebee;
            color: #c62828;
        }
        
        /* TOOLBAR */
        .toolbar {
            background: white;
            padding: 20px 40px;
            border-bottom: 2px solid var(--light);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        
        .toolbar-left {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            flex: 1;
        }
        
        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
            max-width: 400px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .filter-group {
            display: flex;
            gap: 8px;
            background: var(--light);
            padding: 4px;
            border-radius: 8px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--dark);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .filter-btn:hover {
            background: rgba(199, 125, 170, 0.1);
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-outline {
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* LOADING SPINNER */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* STATS BAR */
        .stats-bar {
            background: #fff9fc;
            padding: 20px 40px;
            display: flex;
            gap: 30px;
            overflow-x: auto;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--gray);
            margin-top: 4px;
        }
        
        /* CONTENT AREA */
        .content-area {
            padding: 30px 40px;
            min-height: 500px;
        }
        
        .view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .view-toggle {
            display: flex;
            gap: 8px;
        }
        
        .sort-select {
            padding: 8px 16px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* TESTIMONIALS GRID */
        .testimonials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .testimonials-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .testimonial-card {
            background: white;
            border: 2px solid var(--light);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
            position: relative;
        }
        
        .testimonial-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(199, 125, 170, 0.15);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .user-info {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
        }
        
        .user-details h3 {
            font-size: 16px;
            color: var(--dark);
            margin-bottom: 2px;
        }
        
        .user-details .date {
            font-size: 12px;
            color: var(--gray);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-unpublished {
            background: #e0e0e0;
            color: #666;
        }
        
        .status-published {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-scheduled {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .card-message {
            color: var(--dark);
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .card-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: var(--gray);
        }
        
        .platform-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .platform-tag {
            padding: 4px 10px;
            background: var(--light);
            color: var(--primary-dark);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .card-notes {
            background: #fffbf0;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            color: var(--dark);
            margin-bottom: 15px;
            border-left: 3px solid var(--warning);
        }
        
        .card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .action-btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .action-btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .action-btn-outline {
            background: white;
            border: 2px solid var(--light);
            color: var(--dark);
        }
        
        .action-btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        
        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-header h2 {
            font-size: 24px;
            color: var(--dark);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--gray);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: var(--light);
            color: var(--dark);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        /* SCREENSHOT MODE */
        .screenshot-mode .toolbar,
        .screenshot-mode .stats-bar,
        .screenshot-mode .view-controls,
        .screenshot-mode .card-actions {
            display: none !important;
        }
        
        .screenshot-mode .testimonial-card {
            break-inside: avoid;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .toolbar-left,
            .toolbar-right {
                flex-direction: column;
                width: 100%;
            }
            
            .search-box {
                max-width: 100%;
            }
            
            .filter-group {
                flex-wrap: wrap;
            }
            
            .testimonials-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="app-header">
            <h1>üå∏ T√©moignages √âcole des Gu√©risseuses</h1>
            <p>G√©rez et publiez vos t√©moignages avec amour</p>
        </div>
        
        <!-- CONFIG PANEL -->
        <div class="config-panel" id="configPanel">
            <h3>‚öôÔ∏è Configuration Notion</h3>
            <div class="config-form">
                <div class="config-input-group">
                    <label>Cl√© API Notion (secret_...)</label>
                    <input type="password" id="notionApiKey" placeholder="secret_xxxxxxxxxxxxx">
                </div>
                <div class="config-input-group">
                    <label>ID de la Database (32 caract√®res)</label>
                    <input type="text" id="notionDatabaseId" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                </div>
                <div class="config-buttons">
                    <button class="btn btn-primary" onclick="saveNotionConfig()">Enregistrer</button>
                    <button class="btn btn-outline" onclick="testNotionConnection()">Tester la connexion</button>
                </div>
                <div id="configStatus" class="config-status" style="display: none;"></div>
            </div>
        </div>
        
        <!-- TOOLBAR -->
        <div class="toolbar">
            <div class="toolbar-left">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Rechercher un t√©moignage...">
                    <span class="search-icon">üîç</span>
                </div>
                
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="all">Tous</button>
                    <button class="filter-btn" data-filter="unpublished">Non publi√©s</button>
                    <button class="filter-btn" data-filter="published">Publi√©s</button>
                    <button class="filter-btn" data-filter="scheduled">Programm√©s</button>
                </div>
                
                <div class="filter-group">
                    <button class="filter-btn active" data-length-filter="all">Toutes longueurs</button>
                    <button class="filter-btn" data-length-filter="short">Courts (‚â§500)</button>
                    <button class="filter-btn" data-length-filter="medium">Moyens (501-1000)</button>
                    <button class="filter-btn" data-length-filter="long">Longs (1001-2000)</button>
                    <button class="filter-btn" data-length-filter="verylong">Tr√®s longs (2000+)</button>
                </div>
            </div>
            
            <div class="toolbar-right">
                <button class="btn btn-primary" onclick="openImportModal()" id="importBtn">
                    üì• Importer
                </button>
                <button class="btn btn-outline" onclick="exportData()" id="exportBtn">
                    üì§ Exporter
                </button>
                <button class="btn btn-outline" onclick="loadTestimonials()" id="refreshBtn">
                    üîÑ Actualiser
                </button>
            </div>
        </div>
        
        <!-- STATS BAR -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statPublished">0</div>
                <div class="stat-label">Publi√©s</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statScheduled">0</div>
                <div class="stat-label">Programm√©s</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statShort">0</div>
                <div class="stat-label">Courts (‚â§500)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statMedium">0</div>
                <div class="stat-label">Moyens (501-1000)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statLong">0</div>
                <div class="stat-label">Longs (1001-2000)</div>
            </div>
        </div>
        
        <!-- CONTENT AREA -->
        <div class="content-area">
            <div class="view-controls">
                <div class="view-toggle">
                    <button class="filter-btn active" onclick="setView('grid')">üî≤ Grille</button>
                    <button class="filter-btn" onclick="setView('list')">üìã Liste</button>
                </div>
                
                <select class="sort-select" id="sortSelect" onchange="applySorting()">
                    <option value="date-desc">Plus r√©cents d'abord</option>
                    <option value="date-asc">Plus anciens d'abord</option>
                    <option value="length-desc">Plus longs d'abord</option>
                    <option value="length-asc">Plus courts d'abord</option>
                </select>
            </div>
            
            <div id="testimonialsContainer" class="testimonials-grid"></div>
        </div>
    </div>
    
    <!-- EDIT MODAL -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è √âditer le t√©moignage</h2>
                <button class="close-btn" onclick="closeEditModal()">√ó</button>
            </div>
            
            <input type="hidden" id="editPageId">
            
            <div class="form-group">
                <label>Statut</label>
                <select id="editStatus">
                    <option value="unpublished">Non publi√©</option>
                    <option value="published">Publi√©</option>
                    <option value="scheduled">Programm√©</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Date de publication</label>
                <input type="date" id="editPublishDate">
            </div>
            
            <div class="form-group">
                <label>Plateformes</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="platform_instagram">
                        <label for="platform_instagram">Instagram</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="platform_facebook">
                        <label for="platform_facebook">Facebook</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="platform_linkedin">
                        <label for="platform_linkedin">LinkedIn</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="platform_website">
                        <label for="platform_website">Site Web</label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Notes internes</label>
                <textarea id="editNotes" placeholder="Ajoutez des notes..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeEditModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveEdit()">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- IMPORT MODAL -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì• Importer des t√©moignages</h2>
                <button class="close-btn" onclick="closeImportModal()">√ó</button>
            </div>
            
            <div class="form-group">
                <label>Format</label>
                <select id="importFormat">
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Fichier</label>
                <input type="file" id="importFile" accept=".csv,.json">
            </div>
            
            <div class="form-group">
                <label>Ou collez vos donn√©es ici</label>
                <textarea id="importData" placeholder="Collez vos donn√©es CSV ou JSON ici..." rows="10"></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeImportModal()">Annuler</button>
                <button class="btn btn-primary" onclick="processImport()">Importer</button>
            </div>
        </div>
    </div>

    <script>
        // STATE
        const appState = {
            notionApiKey: localStorage.getItem('notionApiKey') || '',
            notionDatabaseId: localStorage.getItem('notionDatabaseId') || '',
            testimonials: [],
            filteredTestimonials: [],
            currentFilter: 'all',
            currentLengthFilter: 'all',
            searchQuery: '',
            currentSort: 'date-desc',
            currentView: 'grid',
            isLoading: false
        };
        
        // NOTION API HELPERS via Netlify Functions
        async function notionRequest(endpoint, method = 'GET', body = null) {
            if (!appState.notionApiKey || !appState.notionDatabaseId) {
                throw new Error('Configuration Notion manquante');
            }
            
            const requestBody = {
                apiKey: appState.notionApiKey,
                databaseId: appState.notionDatabaseId,
                endpoint: endpoint,
                method: method,
                data: body
            };
            
            const response = await fetch('/.netlify/functions/notion-api', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Erreur API Notion');
            }
            
            return response.json();
        }
        
        // NOTION CONFIG
        function saveNotionConfig() {
            const apiKey = document.getElementById('notionApiKey').value.trim();
            const databaseId = document.getElementById('notionDatabaseId').value.trim();
            
            if (!apiKey || !databaseId) {
                showConfigStatus('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            appState.notionApiKey = apiKey;
            appState.notionDatabaseId = databaseId;
            
            localStorage.setItem('notionApiKey', apiKey);
            localStorage.setItem('notionDatabaseId', databaseId);
            
            showConfigStatus('Configuration enregistr√©e ‚úì', 'success');
            
            // Cacher le panneau et charger les donn√©es
            setTimeout(() => {
                document.getElementById('configPanel').classList.add('hidden');
                loadTestimonials();
            }, 1000);
        }
        
        async function testNotionConnection() {
            try {
                showConfigStatus('Test en cours...', 'success');
                await notionRequest(`/databases/${appState.notionDatabaseId}`);
                showConfigStatus('Connexion r√©ussie ‚úì', 'success');
            } catch (error) {
                showConfigStatus('Erreur: ' + error.message, 'error');
            }
        }
        
        function showConfigStatus(message, type) {
            const statusEl = document.getElementById('configStatus');
            statusEl.textContent = message;
            statusEl.className = `config-status ${type}`;
            statusEl.style.display = 'block';
        }
        
        // LOAD TESTIMONIALS FROM NOTION
        async function loadTestimonials() {
            if (!appState.notionApiKey || !appState.notionDatabaseId) {
                document.getElementById('configPanel').classList.remove('hidden');
                return;
            }
            
            setLoading(true);
            
            try {
                const response = await notionRequest(`/databases/${appState.notionDatabaseId}/query`, 'POST', {
                    page_size: 100
                });
                
                appState.testimonials = response.results.map(page => ({
                    pageId: page.id,
                    prenom: page.properties['Pr√©nom']?.rich_text[0]?.plain_text || '',
                    nom: page.properties['Nom']?.rich_text[0]?.plain_text || '',
                    date: page.properties['Date']?.date?.start || '',
                    heure: page.properties['Heure']?.rich_text[0]?.plain_text || '',
                    message: page.properties['Message']?.rich_text[0]?.plain_text || '',
                    status: page.properties['Statut']?.select?.name?.toLowerCase().replace(' ', '') || 'unpublished',
                    publishDate: page.properties['Date publication']?.date?.start || null,
                    platforms: page.properties['Plateformes']?.multi_select?.map(p => p.name) || [],
                    notes: page.properties['Notes']?.rich_text[0]?.plain_text || '',
                    score: page.properties['Score']?.number || 0
                }));
                
                filterTestimonials();
            } catch (error) {
                alert('Erreur lors du chargement: ' + error.message);
                console.error(error);
            } finally {
                setLoading(false);
            }
        }
        
        // CREATE TESTIMONIAL IN NOTION
        async function createTestimonial(testimonial) {
            const properties = {
                'Pr√©nom': {
                    rich_text: [{ text: { content: testimonial.prenom || '' } }]
                },
                'Nom': {
                    rich_text: [{ text: { content: testimonial.nom || '' } }]
                },
                'Date': {
                    date: testimonial.date ? { start: testimonial.date } : null
                },
                'Heure': {
                    rich_text: [{ text: { content: testimonial.heure || '' } }]
                },
                'Message': {
                    rich_text: [{ text: { content: testimonial.message || '' } }]
                },
                'Statut': {
                    select: { 
                        name: testimonial.status === 'published' ? 'Publi√©' : 
                              testimonial.status === 'scheduled' ? 'Programm√©' : 'Non publi√©' 
                    }
                },
                'Plateformes': {
                    multi_select: (testimonial.platforms || []).map(p => ({ name: p }))
                },
                'Notes': {
                    rich_text: [{ text: { content: testimonial.notes || '' } }]
                },
                'Score': {
                    number: testimonial.score || 0
                }
            };
            
            if (testimonial.publishDate) {
                properties['Date publication'] = {
                    date: { start: testimonial.publishDate }
                };
            }
            
            return notionRequest('/pages', 'POST', {
                parent: { database_id: appState.notionDatabaseId },
                properties
            });
        }
        
        // UPDATE TESTIMONIAL IN NOTION
        async function updateTestimonial(pageId, updates) {
            const properties = {};
            
            if (updates.status !== undefined) {
                properties['Statut'] = {
                    select: { 
                        name: updates.status === 'published' ? 'Publi√©' : 
                              updates.status === 'scheduled' ? 'Programm√©' : 'Non publi√©' 
                    }
                };
            }
            
            if (updates.publishDate !== undefined) {
                properties['Date publication'] = updates.publishDate ? 
                    { date: { start: updates.publishDate } } : 
                    { date: null };
            }
            
            if (updates.platforms !== undefined) {
                properties['Plateformes'] = {
                    multi_select: updates.platforms.map(p => ({ name: p }))
                };
            }
            
            if (updates.notes !== undefined) {
                properties['Notes'] = {
                    rich_text: [{ text: { content: updates.notes } }]
                };
            }
            
            return notionRequest(`/pages/${pageId}`, 'PATCH', { properties });
        }
        
        // FILTER & RENDER
        function filterTestimonials() {
            let filtered = [...appState.testimonials];
            
            // Filtre par statut
            if (appState.currentFilter !== 'all') {
                filtered = filtered.filter(t => t.status === appState.currentFilter);
            }
            
            // Filtre par longueur
            if (appState.currentLengthFilter !== 'all') {
                filtered = filtered.filter(t => {
                    const length = t.message.length;
                    switch(appState.currentLengthFilter) {
                        case 'short':
                            return length <= 500;
                        case 'medium':
                            return length > 500 && length <= 1000;
                        case 'long':
                            return length > 1000 && length <= 2000;
                        case 'verylong':
                            return length > 2000;
                    }
                    return true;
                });
            }
            
            // Recherche
            if (appState.searchQuery) {
                const query = appState.searchQuery.toLowerCase();
                filtered = filtered.filter(t => 
                    t.prenom.toLowerCase().includes(query) ||
                    t.nom.toLowerCase().includes(query) ||
                    t.message.toLowerCase().includes(query)
                );
            }
            
            // Tri
            filtered.sort((a, b) => {
                switch(appState.currentSort) {
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'length-desc':
                        return b.message.length - a.message.length;
                    case 'length-asc':
                        return a.message.length - b.message.length;
                }
                return 0;
            });
            
            appState.filteredTestimonials = filtered;
            renderTestimonials();
            updateStats();
        }
        
        function renderTestimonials() {
            const container = document.getElementById('testimonialsContainer');
            
            if (appState.filteredTestimonials.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Aucun t√©moignage trouv√©</h3>
                        <p>Importez vos premiers t√©moignages pour commencer</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appState.filteredTestimonials.map(t => {
                const statusLabel = t.status === 'published' ? 'Publi√©' : 
                                  t.status === 'scheduled' ? 'Programm√©' : 'Non publi√©';
                const statusClass = `status-${t.status}`;
                
                const platformTags = t.platforms && t.platforms.length > 0 ? 
                    `<div class="platform-tags">
                        ${t.platforms.map(p => `<span class="platform-tag">${p}</span>`).join('')}
                    </div>` : '';
                
                const notesHtml = t.notes ? 
                    `<div class="card-notes">üìù ${t.notes}</div>` : '';
                
                const publishDateHtml = t.publishDate ? 
                    `<div class="meta-item">üìÖ ${new Date(t.publishDate).toLocaleDateString('fr-FR')}</div>` : '';
                
                return `
                    <div class="testimonial-card">
                        <div class="card-header">
                            <div class="user-info">
                                <div class="user-avatar" style="background: ${getAvatarColor(t.prenom)}">
                                    ${t.prenom.charAt(0).toUpperCase()}
                                </div>
                                <div class="user-details">
                                    <h3>${t.prenom} ${t.nom}</h3>
                                    <div class="date">${formatDate(t.date)} ${t.heure}</div>
                                </div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusLabel}</span>
                        </div>
                        
                        ${platformTags}
                        
                        <div class="card-message">${t.message}</div>
                        
                        <div class="card-meta">
                            <div class="meta-item">üìè ${t.message.length} caract√®res</div>
                            ${publishDateHtml}
                        </div>
                        
                        ${notesHtml}
                        
                        <div class="card-actions">
                            <button class="action-btn action-btn-primary" onclick="quickToggleStatus('${t.pageId}')">
                                ${t.status === 'published' ? '‚ùå D√©publier' : '‚úÖ Publier'}
                            </button>
                            <button class="action-btn action-btn-outline" onclick="editTestimonial('${t.pageId}')">
                                ‚úèÔ∏è √âditer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateStats() {
            const total = appState.testimonials.length;
            const published = appState.testimonials.filter(t => t.status === 'published').length;
            const scheduled = appState.testimonials.filter(t => t.status === 'scheduled').length;
            
            const short = appState.testimonials.filter(t => t.message.length <= 500).length;
            const medium = appState.testimonials.filter(t => t.message.length > 500 && t.message.length <= 1000).length;
            const long = appState.testimonials.filter(t => t.message.length > 1000 && t.message.length <= 2000).length;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPublished').textContent = published;
            document.getElementById('statScheduled').textContent = scheduled;
            document.getElementById('statShort').textContent = short;
            document.getElementById('statMedium').textContent = medium;
            document.getElementById('statLong').textContent = long;
        }
        
        // HELPERS
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function getAvatarColor(name) {
            const colors = ['#c77daa', '#b8659d', '#d89bb8', '#7fb69e', '#e07a8a'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }
        
        function setLoading(loading) {
            appState.isLoading = loading;
            const buttons = ['importBtn', 'exportBtn', 'refreshBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = loading;
            });
        }
        
        // QUICK TOGGLE STATUS
        async function quickToggleStatus(pageId) {
            const testimonial = appState.testimonials.find(t => t.pageId === pageId);
            if (!testimonial) return;
            
            const newStatus = testimonial.status === 'unpublished' ? 'published' : 'unpublished';
            const updates = {
                status: newStatus,
                publishDate: newStatus === 'published' ? new Date().toISOString().split('T')[0] : null
            };
            
            try {
                await updateTestimonial(pageId, updates);
                testimonial.status = newStatus;
                testimonial.publishDate = updates.publishDate;
                filterTestimonials();
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }
        
        // EDIT TESTIMONIAL
        function editTestimonial(pageId) {
            const testimonial = appState.testimonials.find(t => t.pageId === pageId);
            if (!testimonial) return;
            
            document.getElementById('editPageId').value = pageId;
            document.getElementById('editStatus').value = testimonial.status;
            document.getElementById('editNotes').value = testimonial.notes || '';
            document.getElementById('editPublishDate').value = testimonial.publishDate || '';
            
            document.getElementById('platform_instagram').checked = (testimonial.platforms || []).includes('Instagram');
            document.getElementById('platform_facebook').checked = (testimonial.platforms || []).includes('Facebook');
            document.getElementById('platform_linkedin').checked = (testimonial.platforms || []).includes('LinkedIn');
            document.getElementById('platform_website').checked = (testimonial.platforms || []).includes('Site Web');
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        
        async function saveEdit() {
            const pageId = document.getElementById('editPageId').value;
            const testimonial = appState.testimonials.find(t => t.pageId === pageId);
            if (!testimonial) return;
            
            const platforms = [];
            if (document.getElementById('platform_instagram').checked) platforms.push('Instagram');
            if (document.getElementById('platform_facebook').checked) platforms.push('Facebook');
            if (document.getElementById('platform_linkedin').checked) platforms.push('LinkedIn');
            if (document.getElementById('platform_website').checked) platforms.push('Site Web');
            
            const updates = {
                status: document.getElementById('editStatus').value,
                notes: document.getElementById('editNotes').value,
                publishDate: document.getElementById('editPublishDate').value || null,
                platforms: platforms
            };
            
            try {
                await updateTestimonial(pageId, updates);
                Object.assign(testimonial, updates);
                filterTestimonials();
                closeEditModal();
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }
        
        // FILTERS
        document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                appState.currentFilter = this.dataset.filter;
                filterTestimonials();
            });
        });
        
        document.querySelectorAll('.filter-btn[data-length-filter]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn[data-length-filter]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                appState.currentLengthFilter = this.dataset.lengthFilter;
                filterTestimonials();
            });
        });
        
        // SEARCH
        document.getElementById('searchInput').addEventListener('input', function(e) {
            appState.searchQuery = e.target.value;
            filterTestimonials();
        });
        
        // SORT
        function applySorting() {
            appState.currentSort = document.getElementById('sortSelect').value;
            filterTestimonials();
        }
        
        // VIEW
        function setView(view) {
            appState.currentView = view;
            const container = document.getElementById('testimonialsContainer');
            
            document.querySelectorAll('.view-toggle .filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (view === 'grid') {
                container.className = 'testimonials-grid';
            } else {
                container.className = 'testimonials-list';
            }
        }
        
        // EXPORT
        function exportData() {
            const data = appState.testimonials.map(t => ({
                'Pr√©nom': t.prenom,
                'Nom': t.nom || '',
                'Date': t.date,
                'Heure': t.heure,
                'Statut': t.status === 'published' ? 'Publi√©' : t.status === 'scheduled' ? 'Programm√©' : 'Non publi√©',
                'Date publication': t.publishDate ? new Date(t.publishDate).toLocaleDateString('fr-FR') : '',
                'Plateformes': (t.platforms || []).join(', '),
                'Notes': t.notes || '',
                'Longueur': t.message.length,
                'Message': t.message
            }));
            
            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `temoignages_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // IMPORT
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }
        
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.getElementById('importData').value = '';
            document.getElementById('importFile').value = '';
        }
        
        async function processImport() {
            const format = document.getElementById('importFormat').value;
            const data = document.getElementById('importData').value;
            
            if (!data.trim()) {
                alert('Veuillez coller des donn√©es √† importer');
                return;
            }
            
            try {
                if (format === 'csv') {
                    await importCSV(data);
                } else {
                    await importJSON(data);
                }
            } catch(e) {
                alert('Erreur lors de l\'import: ' + e.message);
                console.error(e);
            }
        }
        
        async function importCSV(csvData) {
            const lines = csvData.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            const newTestimonials = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                
                let message = values[headers.indexOf('Message')] || '';
                
                // Tronquer si > 2000 caract√®res
                if (message.length > 2000) {
                    message = message.substring(0, 1950) + '...';
                }
                
                const testimonial = {
                    prenom: values[headers.indexOf('First Name')] || values[headers.indexOf('Pr√©nom')] || '',
                    nom: values[headers.indexOf('Last Name')] || values[headers.indexOf('Nom')] || '',
                    date: values[headers.indexOf('Date')] ? values[headers.indexOf('Date')].split(' ')[0] : '',
                    heure: values[headers.indexOf('Date')] ? values[headers.indexOf('Date')].split(' ')[1] || '' : '',
                    message: message,
                    status: 'unpublished',
                    platforms: [],
                    notes: '',
                    publishDate: null,
                    score: 0
                };
                
                newTestimonials.push(testimonial);
            }
            
            // Importer dans Notion
            setLoading(true);
            let imported = 0;
            
            try {
                for (const testimonial of newTestimonials) {
                    await createTestimonial(testimonial);
                    imported++;
                }
                
                alert(`${imported} t√©moignages import√©s avec succ√®s dans Notion !`);
                await loadTestimonials();
                closeImportModal();
            } catch (error) {
                alert(`Erreur apr√®s ${imported} imports: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }
        
        async function importJSON(jsonData) {
            const data = JSON.parse(jsonData);
            const newTestimonials = data.map(t => {
                let message = t.message || '';
                if (message.length > 2000) {
                    message = message.substring(0, 1950) + '...';
                }
                
                return {
                    ...t,
                    message: message,
                    status: t.status || 'unpublished',
                    platforms: t.platforms || [],
                    notes: t.notes || '',
                    publishDate: t.publishDate || null
                };
            });
            
            setLoading(true);
            let imported = 0;
            
            try {
                for (const testimonial of newTestimonials) {
                    await createTestimonial(testimonial);
                    imported++;
                }
                
                alert(`${imported} t√©moignages import√©s avec succ√®s dans Notion !`);
                await loadTestimonials();
                closeImportModal();
            } catch (error) {
                alert(`Erreur apr√®s ${imported} imports: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }
        
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current.trim());
            return values;
        }
        
        // FILE UPLOAD
        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('importData').value = event.target.result;
                const ext = file.name.split('.').pop().toLowerCase();
                document.getElementById('importFormat').value = ext === 'json' ? 'json' : 'csv';
            };
            reader.readAsText(file);
        });
        
        // INIT
        document.addEventListener('DOMContentLoaded', function() {
            // Pr√©-remplir la config si d√©j√† sauvegard√©e
            if (appState.notionApiKey) {
                document.getElementById('notionApiKey').value = appState.notionApiKey;
            }
            if (appState.notionDatabaseId) {
                document.getElementById('notionDatabaseId').value = appState.notionDatabaseId;
            }
            
            // Charger les t√©moignages si config OK
            if (appState.notionApiKey && appState.notionDatabaseId) {
                document.getElementById('configPanel').classList.add('hidden');
                loadTestimonials();
            }
        });
    </script>
</body>
</html>
